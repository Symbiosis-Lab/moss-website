# Deep Link Implementation Breakthrough

> The hardest bugs hide in the gap between what we expect and what actually exists.

## Problem: Deep Links Not Working

After implementing LaunchServices registration correctly and fixing multiple configuration issues, deep links still weren't triggering the publishing workflow. The mystery: `open "moss://publish?path=..."` would launch the app but not process the URL.

## Root Cause Discovery

**The Fundamental Mistake**: Using generic Tauri event system instead of the dedicated deep link API.

```rust
// ❌ What we had (wrong)
app.listen("deep-link://new-url", move |event| {
    if let Ok(urls) = serde_json::from_str::<Vec<String>>(&event.payload()) {
        // Never triggered
    }
});

// ✅ What we needed (correct)
app.deep_link().on_open_url(move |event| {
    let urls = event.urls();  // Direct access, proper typing
    // Actually receives events
});
```

## The Investigation Path

1. **LaunchServices Confusion**: Multiple app registrations (debug/release/production) created routing conflicts
2. **Event Format Assumptions**: Expected JSON strings, got `tauri::Url` objects
3. **API Misunderstanding**: Generic events vs. dedicated deep link handlers

## Key Insights

### Tauri v2 Deep Link Architecture

- **Plugin-Specific APIs**: v2 uses `app.deep_link().on_open_url()`, not generic `app.listen()`
- **Type Safety**: Returns `tauri::Url` objects, not strings - use `url.as_str()`
- **Development Limitations**: Deep links require installed apps on macOS, not dev mode

### LaunchServices Database Management

- **Conflict Resolution**: `lsregister -kill -r` resets the entire database
- **Targeted Registration**: `lsregister -f /Applications/App.app` registers specific apps
- **Debug Visibility**: `lsregister -dump | grep scheme` shows current registrations

### System Integration Reality

The gap between development environment and production deployment is wider than expected. Deep links are a system-level integration that can't be fully tested in development mode on macOS.

## Resolution

**Immediate Fix**: Replace event handler with proper API
**Verification**: `open "moss://publish?path=/path/to/folder"` now generates complete static sites
**Result**: End-to-end workflow working from command line to browser preview

## What This Teaches

Sometimes the solution isn't deeper debugging—it's stepping back to verify fundamental assumptions. We were debugging event parsing when the events weren't reaching the handler at all.

The most productive debugging question: "Is this code even running?"

## References

**Tauri v2 Documentation:**
- [Deep Linking Plugin Guide](https://v2.tauri.app/plugin/deep-linking/) - Official setup and configuration
- [JavaScript Deep Link API](https://v2.tauri.app/reference/javascript/deep-link/) - Complete API reference

**macOS System Integration:**
- LaunchServices debugging: `lsregister -dump | grep scheme` for visibility
- Protocol registration requires installed apps, not development builds
- Multiple app registrations create routing conflicts

**Key Insight:** Always verify API assumptions with official documentation. Generic event systems vs. plugin-specific APIs have different behaviors in Tauri v2.

---

*Next: Deployment integration for moss.pub publishing*